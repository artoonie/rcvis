{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'bargraph/style.css' %}">

<div class="container-fluid">
    <div class="row d-flex justify-content-left align-items-start" id="bargraph-container">
        <div class="col-12" id="bargraph-slider-container"> <div id="slider-step"></div></div>
        <div class="col-l-12 col-xl-11" id="bargraph-interactive-body"> </div>
        <div class="col-l-12 col-xl-1" id="bargraph-interactive-legend">
            Legend
            <hr>
        </div>
    </div>
</div>

{% if offlineMode %}
{% load static %}
<script src="{% static 'localdeps/d3-simple-slider.min.js' %}"></script>
{% else %}
<script src="https://unpkg.com/d3-simple-slider"></script>
{% endif %}

<script type="text/javascript">


{{ bargraphjs|safe }}

// For slider TODO sync with tabular-by-round-interactive.html
var viewboxWidth = numRounds * 50 + 120;
var viewboxHeight = 70;

// Fix the max height to not be too wide
var pixelRatio = 0;
function fixMaxWidth() {
    var currPixelRatio = window.devicePixelRatio;
    currPixelRatio = Math.min(currPixelRatio, 1.5); // TODO hack, this looks nicer
    if(pixelRatio == currPixelRatio) return;
    pixelRatio = currPixelRatio;
    // TODO sync this 550 with the one in barchart.js
    document.getElementById('bargraph-container').style.maxWidth = pixelRatio*550 + "px";
}
fixMaxWidth();
window.onresize = fixMaxWidth;

// Step slider c/o https://bl.ocks.org/johnwalley/e1d256b81e51da68f7feb632a53c3518
var sliderStep = d3
  .sliderBottom()
  .min(1)
  .max(numRounds)
  .width(numRounds * 45)
  .height(50)
    .tickFormat(function(d) { return "Round " + d;})
  .ticks(numRounds)
  .step(1)
  .default(numRounds)
  .on('onchange', val => {
    transitionEachBarForRound(val);
  });

var gStep = d3
  .select('div#slider-step')
  .append('svg')
  .attr("viewBox", "0 0 " + viewboxWidth + " " + viewboxHeight)
  .attr("width", "100%")
  .append('g')
  .attr('transform', 'translate(100,30)');

gStep.call(sliderStep);

var interactive = true;
var doHideOverflowAndEliminated = {% if config.doHideOverflowAndEliminated %} true {% else %} false {% endif %};
var doUseHorizontalBarGraph = {% if config.doUseHorizontalBarGraph %} true {% else %} false {% endif %};
transitionEachBarForRound = makeBarGraph("#bargraph-interactive-body","#bargraph-interactive-legend", data, candidatesRange, totalVotesPerRound, numRoundsTilWin, colors, longestLabelApxWidth, interactive, threshold, doHideOverflowAndEliminated, !doUseHorizontalBarGraph);
</script>
