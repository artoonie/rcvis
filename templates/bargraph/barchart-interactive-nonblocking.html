{% load static %}

<script type="text/javascript">

var isBargraphAnimationInProgress = false;

function showTextOnRoundDescriber(description) {
  if (isBargraphAnimationInProgress) {
    return;
  }

  const idOfLegendOrRoundDescriber = "#bargraph-interactive-round-description";

  d3.select(idOfLegendOrRoundDescriber)
  .transition()
    .duration(100)
    .delay(0)
    .style("opacity", "0");

  d3.select(idOfLegendOrRoundDescriber)
  .transition()
    .delay(350)
    .style("opacity", "1")
    .text(description);
};


function descriptionOfCurrRound(round) {
  const roundData = humanFriendlyEventsPerRound[round];

  let roundText = roundData.map(function(event) {
    return event.description;
  }).reduce(function(totalString, currText) {
    return totalString + "\n" + currText;
  }, "");

  // Last round gets a summary, too
  const numRounds = {{ tabularByRoundInteractive.rounds|length }};
  if (round == numRounds - 1) {
    roundText += "{{ humanFriendlySummary|safe }}";
  }
  return roundText;
}


function makeInteractiveGraph() {
  {{ bargraphjs|safe }}

  // For slider TODO sync with tabular-by-round-interactive.html
  const numRounds = {{ tabularByRoundInteractive.rounds|length }};

  const numCandidates = candidateVoteCounts.length;
  fixMaxWidthFor('bargraph-interactive-body', numCandidates);
  // window.onresize = fixMaxWidth; TODO fix moving across monitors for interactive and static

  const isInteractive = true;
  transitionEachBarForRound = makeBarGraph({
    idOfContainer: "#bargraph-interactive-body",
    idOfLegend: null,
    candidateVoteCounts,
    humanFriendlyRoundNames,
    totalVotesPerRound,
    numRoundsTilWin,
    colors: colorsPerRound,
    longestLabelApxWidth,
    isInteractive,
    threshold,
    eliminationBarColor: config.eliminationBarColor,
    isVertical: !config.doUseHorizontalBarGraph,
    doDimPrevRoundColors: config.doDimPrevRoundColors
  });

  function sliderValueChangedCallback(round) {
    transitionEachBarForRound(round);
    showTextOnRoundDescriber(descriptionOfCurrRound(round))
  }

  trs_createSliderAndTimeline({
    wrapperDivId: 'bargraph-slider-container',
    numTicks: numRounds,
    color: colorsPerRound,
    tickText: generateTickTexts(numRounds),
    hideActiveTickText: doHideActiveTickText(numRounds),
    sliderValueChanged: sliderValueChangedCallback,
    timelineData: generateTimelineData(humanFriendlyEventsPerRound),
    timelinePeeking: !config.doUseDescriptionInsteadOfTimeline,
    timeBetweenStepsMs: 350
  });
}
makeInteractiveGraph();
</script>
